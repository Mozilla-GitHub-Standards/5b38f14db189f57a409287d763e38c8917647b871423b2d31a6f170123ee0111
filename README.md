# Mozilla InfoSec Reference Implementation of Kubernetes

## Turning up a cluster for N00Bz

_Currently only supported in dev._

```
export STAGE=dev
export AWS_REGION=us-west-2
export KOPS_STATE_STORE=s3://kops.security.allizom.org
export NAME=us-west-2.infra.security.allizom.org

ansible-playbook -c local ansible/find_or_create_single.yml -e clustername=${NAME}
```

## Deleting a Cluster

_Currently only supported in dev._

```
export STAGE=dev
export AWS_REGION=us-west-2
export KOPS_STATE_STORE=s3://kops.security.allizom.org
export NAME=us-west-2.infra.security.allizom.org

ansible-playbook -c local ansible/delete_single.yml -e clustername=${NAME}
```

## Running this set of tooling locally ( for ansible-dev )

__Dev__

```
export STAGE=dev
export AWS_REGION=us-west-2
export KOPS_STATE_STORE=s3://kops.security.allizom.org
export NAME=us-west-2.infra.security.allizom.org
export DNS=public
export ZONE_ID=Z1AY0K1T7473M8
export NODE_SIZE=c4.large
export MASTER_SIZE=c4.large
```

## To deploy a single region

### The long way round
```
# Render the template
# From the directory kops configs

kops toolbox template --values values/${STAGE}/${AWS_REGION}.yml --template cluster-1.0.yml > rendered-templates/${STAGE}-${AWS_REGION}.yml

kops create -f rendered-templates/${STAGE}-${AWS_REGION}.yml

kops create secret --name ${NAME} sshpublickey admin -i ~/.ssh/infosec-infra.pub

kops update cluster ${NAME} --yes

# Wait for DNS to propogate if this is a new Cluster

kops validate cluster ${NAME}

```

> Note: This key can be generated by you.  But the one used for infosec is stored in credstash
under the secret name "kubernetes-infra".  It is the same in all regions.

## To Run an Update to a Cluster

```
kops toolbox template --values values/${STAGE}/${AWS_REGION}.yml --template cluster-1.0.yml > rendered-templates/${STAGE}-${AWS_REGION}.yml

kops replace -f rendered-templates/${STAGE}-${AWS_REGION}.yml

kops update cluster ${NAME} --yes

kops rolling-update cluster --yes

kops validate cluster ${NAME}

```

## Exporting Admin Creds

```
kops export kubecfg
```
> Note that this decrypts and fetches the admin credential for the entire cluster.  Use RBAC for everything except setting up RBAC.

## To generate the cluster yaml
### Note: You will likely not need to do this.

kops create cluster \
--node-count 3 \
--zones us-west-2a,us-west-2b,us-west-2c \
--master-zones us-west-2a,us-west-2b,us-west-2c \
--dns ${DNS} \
--dns-zone ${ZONE_ID} \
--node-size ${NODE_SIZE} \
--master-size ${MASTER_SIZE} \
--networking calico \
--encrypt-etcd-storage \
--cloud-labels "Team=InfoSec,Owner=Andrew Krug,Project=IAM,Application=Kubernetes-Reference" \
--image kope.io/k8s-1.8-debian-jessie-amd64-hvm-ebs-2017-12-02 \
${NAME} \
--output yaml \
--dry-run
  ```

## Deploying the Kubernetes Dashboard

```
# From the cluster context.  ( You loaded the secrets )

kubectl create -f https://raw.githubusercontent.com/kubernetes/kops/master/addons/kubernetes-dashboard/v1.7.1.yaml

kops get secrets kube --type secret -oplaintext

```

> The username is admin and the password you've just retrieved from the secret store.  
The url is https://api.{$NAME}
