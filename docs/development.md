# Developing and Testing Against the Ansible Playbook(s)

This is a loose guide of steps that were taken in order to generate the GoLang templates
and other artifacts of the build.  Much of the behavior of kops was derived simply by reading
the source code.

This is an excellent doc for first time contributors to start in since it likely has the most
errata and room for clarity / improvement.  

## To generate the cluster yaml
### Note: You will likely not need to do this.

```bash
  kops create cluster \
  --node-count 3 \
  --zones us-west-2a,us-west-2b,us-west-2c \
  --master-zones us-west-2a,us-west-2b,us-west-2c \
  --dns ${DNS} \
  --dns-zone ${ZONE_ID} \
  --node-size ${NODE_SIZE} \
  --master-size ${MASTER_SIZE} \
  --networking calico \
  --encrypt-etcd-storage \
  --cloud-labels "Team=InfoSec,Owner=Andrew Krug,Project=IAM,Application=Kubernetes-Reference" \
  --image kope.io/k8s-1.8-debian-jessie-amd64-hvm-ebs-2017-12-02 \
  ${NAME} \
  --output yaml \
  --dry-run
```

## To deploy a single region:

### The long way round
```bash
# Render the template
# From the directory kops configs

kops toolbox template --values values/${STAGE}/${AWS_REGION}.yml --template cluster-1.0.yml > rendered-templates/${STAGE}-${AWS_REGION}.yml
kops create -f rendered-templates/${STAGE}-${AWS_REGION}.yml
kops create secret --name ${NAME} sshpublickey admin -i ~/.ssh/infosec-infra.pub
kops update cluster ${NAME} --yes
# Wait for DNS to propogate if this is a new Cluster
kops validate cluster ${NAME}

```

> Note: This key can be generated by you.  But the one used for infosec is stored in credstash
under the secret name "kubernetes-infra".  It is the same in all regions.

## To Run an Update to a Cluster

```bash
kops toolbox template --values values/${STAGE}/${AWS_REGION}.yml --template cluster-1.0.yml > rendered-templates/${STAGE}-${AWS_REGION}.yml
kops replace -f rendered-templates/${STAGE}-${AWS_REGION}.yml
kops update cluster ${NAME} --yes
kops rolling-update cluster --yes
kops validate cluster ${NAME}
```
